{% extends "base.html" %}

{% block title %}Tax History{% endblock %}

{% block content %}
<style>
    .history-card {
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border: none;
        margin-bottom: 15px;
        transition: transform 0.2s;
    }
    .history-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px 10px 0 0;
    }
    .regime-badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }
    .regime-old {
        background: #ffe0e0;
        color: #d32f2f;
    }
    .regime-new {
        background: #e0f2f1;
        color: #00796b;
    }
    .stat-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin: 15px 0;
    }
    .stat-item {
        background: #f5f5f5;
        padding: 12px;
        border-radius: 8px;
        border-left: 4px solid #667eea;
    }
    .stat-label {
        font-size: 12px;
        color: #666;
        margin-bottom: 5px;
    }
    .stat-value {
        font-size: 18px;
        font-weight: 700;
        color: #333;
    }
    .delete-btn {
        padding: 5px 15px;
        font-size: 12px;
    }
    .no-history {
        text-align: center;
        padding: 40px 20px;
        color: #999;
    }
    .pagination-container {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 30px;
    }
</style>

<div class="container mt-5">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <h1 class="mb-4">Tax Calculation History</h1>
            
            <div id="historyContainer">
                <!-- Loading spinner -->
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Pagination -->
            <div id="paginationContainer" class="pagination-container" style="display:none;">
                <button class="btn btn-outline-secondary" id="prevBtn" onclick="loadPage(currentPage - 1)">Previous</button>
                <span id="pageInfo">Page 1</span>
                <button class="btn btn-outline-secondary" id="nextBtn" onclick="loadPage(currentPage + 1)">Next</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
let currentPage = 1;
let totalPages = 1;

function formatCurrency(value) {
    return 'â‚¹' + value.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

function formatDate(dateString) {
    const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
    return new Date(dateString).toLocaleDateString('en-IN', options);
}

async function loadHistory(page = 1) {
    const token = sessionStorage.getItem('access_token') || localStorage.getItem('access_token');
    
    try {
        const response = await axios.get(`/api/tax-history?page=${page}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        currentPage = page;
        totalPages = response.data.pages;
        
        displayHistory(response.data);
        updatePagination();
    } catch (error) {
        const container = document.getElementById('historyContainer');
        container.innerHTML = `
            <div class="alert alert-danger" role="alert">
                Error loading history: ${error.response?.data?.message || error.message}
            </div>
        `;
    }
}

function displayHistory(data) {
    const container = document.getElementById('historyContainer');
    
    if (data.calculations.length === 0) {
        container.innerHTML = `
            <div class="no-history">
                <h3>No Calculations Yet</h3>
                <p>You haven't made any tax calculations yet. <a href="/calculate-tax">Calculate your tax now</a></p>
            </div>
        `;
        return;
    }

    let html = '';
    data.calculations.forEach(calc => {
        const regimeClass = calc.regime === 'old' ? 'regime-old' : 'regime-new';
        const regimeText = calc.regime === 'old' ? 'Old Regime' : 'New Regime';
        
        html += `
            <div class="card history-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <strong>Tax Calculation</strong>
                        <br>
                        <small>${formatDate(calc.created_at)}</small>
                    </div>
                    <span class="regime-badge ${regimeClass}">${regimeText}</span>
                </div>
                <div class="card-body">
                    <div class="stat-grid">
                        <div class="stat-item">
                            <div class="stat-label">Gross Income</div>
                            <div class="stat-value">${formatCurrency(calc.gross_income)}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Deductions</div>
                            <div class="stat-value">${formatCurrency(calc.deductions)}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Taxable Income</div>
                            <div class="stat-value">${formatCurrency(calc.taxable_income)}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Total Tax</div>
                            <div class="stat-value text-danger">${formatCurrency(calc.total_tax)}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Effective Rate</div>
                            <div class="stat-value">${calc.effective_tax_rate.toFixed(2)}%</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Monthly Take-Home</div>
                            <div class="stat-value text-success">${formatCurrency(calc.take_home_monthly)}</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                        <small class="text-muted">
                            <strong>Base Tax:</strong> ${formatCurrency(calc.base_tax)} | 
                            <strong>Surcharge:</strong> ${formatCurrency(calc.surcharge)} | 
                            <strong>Cess:</strong> ${formatCurrency(calc.health_education_cess)}
                        </small>
                    </div>

                    <div style="margin-top: 15px;">
                        <button class="btn btn-danger btn-sm delete-btn" onclick="deleteCalculation(${calc.id})">
                            Delete
                        </button>
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

function updatePagination() {
    const container = document.getElementById('paginationContainer');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const pageInfo = document.getElementById('pageInfo');

    if (totalPages <= 1) {
        container.style.display = 'none';
        return;
    }

    container.style.display = 'flex';
    prevBtn.disabled = currentPage === 1;
    nextBtn.disabled = currentPage === totalPages;
    pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
}

async function deleteCalculation(calcId) {
    if (!confirm('Are you sure you want to delete this calculation?')) {
        return;
    }

    const token = sessionStorage.getItem('access_token') || localStorage.getItem('access_token');
    
    try {
        await axios.delete(`/api/tax-history/${calcId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        alert('Calculation deleted successfully');
        loadHistory(currentPage);
    } catch (error) {
        alert('Error deleting calculation: ' + (error.response?.data?.message || error.message));
    }
}

function loadPage(page) {
    if (page >= 1 && page <= totalPages) {
        loadHistory(page);
    }
}

// Load history on page load
document.addEventListener('DOMContentLoaded', () => {
    loadHistory(1);
});
</script>
{% endblock %}
