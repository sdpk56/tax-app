name: AI Issue Triage

on:
  issues:
    types: [opened, edited]

jobs:
  triage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Extract Issue Details Safely
        id: extract
        run: |
          echo "ISSUE_TITLE<<EOF" >> $GITHUB_ENV
          jq -r .issue.title "$GITHUB_EVENT_PATH" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "ISSUE_BODY<<EOF" >> $GITHUB_ENV
          jq -r .issue.body "$GITHUB_EVENT_PATH" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "ISSUE_NUMBER=$(jq -r .issue.number "$GITHUB_EVENT_PATH")" >> $GITHUB_ENV
      - name: Call OpenAI for Triage Suggestions
        id: ai
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_TITLE: ${{ env.ISSUE_TITLE }}
          ISSUE_BODY: ${{ env.ISSUE_BODY }}
        run: |
          PROMPT="Analyze the following GitHub issue and suggest:
          - a label (bug, feature, question)
          - priority (high, medium, low)
          - the most appropriate team to assign (e.g., frontend, backend, devops)
          - a short summary or first response
          Title: $ISSUE_TITLE
          Body:
          $ISSUE_BODY"
          
          REQUEST=$(jq -n --arg prompt "$PROMPT" '{
            "model": "openai/gpt-4o",
            "messages": [{"role": "user", "content": $prompt}]
          }')
          
          echo "DEBUG: Sending request to GitHub AI API..."
          RESPONSE=$(curl -s -w "\n%{http_code}" https://models.github.ai/inference/chat/completions \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$REQUEST")
          
          # Extract HTTP status code (last line)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          # Extract response body (everything except last line)
          RESPONSE_BODY=$(echo "$RESPONSE" | head -n-1)
          
          echo "DEBUG: HTTP Status Code: $HTTP_CODE"
          echo "DEBUG: Full Response:"
          echo "$RESPONSE_BODY" | jq . 2>/dev/null || echo "$RESPONSE_BODY"
          
          # Try to extract AI response; handle errors gracefully
          AI_RESPONSE=$(echo "$RESPONSE_BODY" | jq -r '.choices[0].message.content // "Error: No response from AI"' 2>/dev/null)
          
          if [[ "$AI_RESPONSE" == "null" ]] || [[ -z "$AI_RESPONSE" ]]; then
            AI_RESPONSE="Error: AI returned null or empty response. Check API status."
          fi
          
          echo "DEBUG: AI Response extracted: $AI_RESPONSE"
          echo "AI_RESPONSE<<EOF" >> $GITHUB_ENV
          echo "$AI_RESPONSE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          ASSIGNED_TEAM=$(echo "$AI_RESPONSE" | grep -i "team to assign" | awk -F ':' '{print $2}' | xargs || true)
          if [[ "$ASSIGNED_TEAM" == "frontend" ]]; then
            echo 'ASSIGNEE=org/frontend-team' >> $GITHUB_ENV
          elif [[ "$ASSIGNED_TEAM" == "backend" ]]; then
            echo 'ASSIGNEE=org/backend-team' >> $GITHUB_ENV
          elif [[ "$ASSIGNED_TEAM" == "devops" ]]; then
            echo 'ASSIGNEE=org/devops-team' >> $GITHUB_ENV
          else
            echo 'ASSIGNEE=' >> $GITHUB_ENV
          fi
      - name: Assign Issue to Team
        if: env.ASSIGNEE != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ env.ISSUE_NUMBER }}
          ASSIGNEE: ${{ env.ASSIGNEE }}
        run: |
          gh issue edit "$ISSUE_NUMBER" --add-assignee "$ASSIGNEE"
      - name: Comment AI Suggestion on Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AI_RESPONSE: ${{ env.AI_RESPONSE }}
          ISSUE_NUMBER: ${{ env.ISSUE_NUMBER }}
        run: |
          echo "$AI_RESPONSE" | gh issue comment "$ISSUE_NUMBER" --body-file -
