
- name: Call OpenAI for Triage Suggestions
  id: ai
  env:
    OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    ISSUE_TITLE: ${{ env.ISSUE_TITLE }}
    ISSUE_BODY: ${{ env.ISSUE_BODY }}
  run: |
    PROMPT="Analyze the following GitHub issue and return a structured response in JSON format with keys:
    label, priority, team, summary.

    Title: ${ISSUE_TITLE:-No title provided}
    Body: ${ISSUE_BODY:-No description provided}

    Example output:
    {
      \"label\": \"bug\",
      \"priority\": \"high\",
      \"team\": \"backend\",
      \"summary\": \"The API returns 401 unauthorized error.\"
    }"

    REQUEST=$(jq -n --arg prompt "$PROMPT" '{
      "model": "gpt-4-turbo",
      "messages": [{"role": "user", "content": $prompt}],
      "temperature": 0.7,
      "max_tokens": 500
    }')

    RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
      -H "Authorization: Bearer $OPENAI_API_KEY" \
      -H "Content-Type: application/json" \
      -d "$REQUEST")

    echo "Full API Response: $RESPONSE"  # Debug log

    AI_RESPONSE=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "AI could not generate a response."')

    echo "AI_RESPONSE<<EOF" >> $GITHUB_ENV
    echo "$AI_RESPONSE" >> $GITHUB_ENV
    echo "EOF" >> $GITHUB_ENV
