
name: AI Issue Triage

on:
  issues:
    types: [opened, edited]

permissions:
  issues: write

jobs:
  triage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Extract Issue Details Safely
        id: extract
        run: |
          echo "ISSUE_TITLE<<EOF" >> $GITHUB_ENV
          jq -r .issue.title "$GITHUB_EVENT_PATH" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          echo "ISSUE_BODY<<EOF" >> $GITHUB_ENV
          jq -r .issue.body "$GITHUB_EVENT_PATH" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          echo "ISSUE_NUMBER=$(jq -r .issue.number "$GITHUB_EVENT_PATH")" >> $GITHUB_ENV

      - name: Call OpenAI for Triage Suggestions
        id: ai
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}  # Your OpenAI key from GitHub Secrets
          ISSUE_TITLE: ${{ env.ISSUE_TITLE }}
          ISSUE_BODY: ${{ env.ISSUE_BODY }}
        run: |
          PROMPT="Analyze the following GitHub issue and suggest:
          - a label (bug, feature, question)
          - priority (high, medium, low)
          - the most appropriate team to assign (e.g., frontend, backend, devops)
          - a short summary or first response

          Title: ${ISSUE_TITLE:-No title provided}
          Body: ${ISSUE_BODY:-No description provided}"

          REQUEST=$(jq -n --arg prompt "$PROMPT" '{
            "model": "gpt-4-turbo",  # Updated model
            "messages": [{"role": "user", "content": $prompt}],
            "temperature": 0.7,
            "max_tokens": 500
          }')

          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$REQUEST")

          echo "Full API Response: $RESPONSE"  # Debug log

          AI_RESPONSE=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "AI could not generate a response."')

          echo "AI_RESPONSE<<EOF" >> $GITHUB_ENV
          echo "$AI_RESPONSE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Comment AI Suggestion on Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AI_RESPONSE: ${{ env.AI_RESPONSE }}
          ISSUE_NUMBER: ${{ env.ISSUE_NUMBER }}
        run: |
          echo "$AI_RESPONSE" | gh issue comment "$ISSUE_NUMBER" --body -
