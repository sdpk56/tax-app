name: CI/CD Pipeline

on:
  # push:
  #   branches:
  #     - main
  # pull_request:
  #   branches:
  #     - main
  workflow_dispatch:

env:
  DOCKER_REGISTRY: docker.io
  IMAGE_TAG: ${{ github.run_id }}
  
jobs:     
  # sonarqube:
  #   name: ðŸ”Ž Code Checkout & SonarQube Code Analysis
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Set up JDK
  #       uses: actions/setup-java@v4
  #       with:
  #         java-version: '17'
  #         distribution: 'temurin'

  #     - name: Setup SonarScanner
  #       run: |
  #         Invoke-WebRequest -Uri "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.8.0.2856.zip" -OutFile "sonar-scanner.zip"
  #         Expand-Archive sonar-scanner.zip -DestinationPath .
  #         echo "sonar-scanner-4.8.0.2856/bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

  #     - name: Run SonarScanner CLI - Backend
  #       run: sonar-scanner.bat -D sonar.projectBaseDir=backend/ -D sonar.projectKey=demo_project
  #       env:
  #         SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  #         SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      # - name: Run SonarScanner CLI - Frontend
      #   run: sonar-scanner.bat -D sonar.projectBaseDir=frontend/ -D sonar.projectKey=demo_project
      #   env:
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      #     SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      
  build-and-push:
    name: ðŸ“¦ Build & Push Docker Images
    runs-on: ubuntu-latest
    #needs: sonarqube
    outputs:
      backend_full_image_name: ${{ secrets.DOCKERHUB_USERNAME }}/tax-backend:${{ env.IMAGE_TAG }}
      frontend_full_image_name: ${{ secrets.DOCKERHUB_USERNAME }}/tax-frontend:${{ env.IMAGE_TAG }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker BuildX
      uses: docker/setup-buildx-action@v3

    # Build Backend Image
    - name: Build Backend Docker Image
      id: build_backend
      run: |
        echo "Building backend Docker image: ${{ secrets.DOCKERHUB_USERNAME }}/tax-backend:${{ env.IMAGE_TAG }}"
        docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/tax-backend:${{ env.IMAGE_TAG }} ./backend
        docker tag ${{ secrets.DOCKERHUB_USERNAME }}/tax-backend:${{ env.IMAGE_TAG }} ${{ secrets.DOCKERHUB_USERNAME }}/tax-backend:latest

    # Build Frontend Image
    - name: Build Frontend Docker Image
      id: build_frontend
      run: |
        echo "Building frontend Docker image: ${{ secrets.DOCKERHUB_USERNAME }}/tax-frontend:${{ env.IMAGE_TAG }}"
        docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/tax-frontend:${{ env.IMAGE_TAG }} ./frontend
        docker tag ${{ secrets.DOCKERHUB_USERNAME }}/tax-frontend:${{ env.IMAGE_TAG }} ${{ secrets.DOCKERHUB_USERNAME }}/tax-frontend:latest

    - name: Login to Docker Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.DOCKER_REGISTRY }}
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Push Backend Docker Image
      run: |
        echo "Pushing backend Docker image: ${{ secrets.DOCKERHUB_USERNAME }}/tax-backend:${{ env.IMAGE_TAG }}"
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/tax-backend:${{ env.IMAGE_TAG }}
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/tax-backend:latest

    - name: Push Frontend Docker Image
      run: |
        echo "Pushing frontend Docker image: ${{ secrets.DOCKERHUB_USERNAME }}/tax-frontend:${{ env.IMAGE_TAG }}"
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/tax-frontend:${{ env.IMAGE_TAG }}
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/tax-frontend:latest

  # notify-on-failure:
  #   name: ðŸ”” Notify on Failure
  #   runs-on: ubuntu-latest
  #   needs: build-and-scan
  #   if: failure()
  #   steps:
  #     - name: Send mail
  #       uses: dawidd6/action-send-mail@v3
  #       with:
  #         server_address: smtp.gmail.com
  #         server_port: 465
  #         secure: true
  #         username: ${{ secrets.EMAIL_USERNAME }}
  #         password: ${{ secrets.EMAIL_PASSWORD }}
  #         subject: 'Workflow Failed: ${{ github.workflow }}'
  #         body: |
  #           Workflow "${{ github.workflow }}" failed on the main branch.
  #           Repository: ${{ github.repository }}
  #           Commit: ${{ github.sha }}
  #           Details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
  #         to: sdpk.ks3@gmail.com
  #         from: GitHub Actions